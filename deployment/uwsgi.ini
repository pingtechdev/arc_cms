# uWSGI configuration for ARC CMS
# Port: 8001 (as requested)
[uwsgi]

# Application settings
module = cms_core.wsgi:application
master = true
processes = 4
threads = 2
max-requests = 1000
max-requests-delta = 50

# Socket settings - using TCP port 8001 instead of Unix socket
socket = 127.0.0.1:${BACKEND_PORT}
# Alternative: Unix socket (uncomment if preferred)
# socket = ${BACKEND_SOCKET}
# chmod-socket = 666

vacuum = true
die-on-term = true

# Process management
pidfile = ${BACKEND_PID}
daemonize = ${BACKEND_LOG_DIR}/uwsgi.log
log-maxsize = 50000000
log-backupcount = 5

# User and group (will be set by systemd)
# uid = ${DEPLOY_USER}
# gid = ${DEPLOY_GROUP}

# Working directory (will be set by systemd)
# chdir = ${BACKEND_DIR}
# home = ${BACKEND_DIR}/venv
# pythonpath = ${BACKEND_DIR}

# Environment variables
env = DJANGO_SETTINGS_MODULE=cms_core.settings

# Performance settings
buffer-size = 32768
harakiri = 60
harakiri-verbose = true
reload-mercy = 10
worker-reload-mercy = 10

# Memory management
memory-report = true
reload-on-as = 512
reload-on-rss = 192

# Security
chown-socket = ${DEPLOY_USER}:${DEPLOY_GROUP}
chmod-socket = 666
single-interpreter = true

# Logging
log-4xx = true
log-5xx = true
log-slow = 2000

# Stats server (optional, for monitoring)
stats = ${BACKEND_STATS}
stats-http = true

# Enable threading
enable-threads = true
thunder-lock = true

# Plugin
plugin = python3

# Lazy loading
lazy-apps = true
single-interpreter = true

# Additional settings for production
# Disable request logging for better performance
disable-logging = false
log-5xx = true
log-4xx = true

# Buffer settings
post-buffering = 8192
buffer-size = 32768

# Process recycling
max-requests = 1000
max-requests-delta = 50
reload-mercy = 10
worker-reload-mercy = 10

# Memory limits
limit-as = 512
reload-on-as = 256
reload-on-rss = 192